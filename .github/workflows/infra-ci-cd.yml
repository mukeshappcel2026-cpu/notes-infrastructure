name: Infrastructure CI/CD

on:
  pull_request:
    branches: [main]
    paths:
      - 'modules/**'
      - 'environments/**'
  push:
    branches: [main]
    paths:
      - 'modules/**'
      - 'environments/**'
      - '.github/workflows/**'
  workflow_dispatch:  # Allow manual triggers

permissions:
  id-token: write   # Required for OIDC
  contents: read
  pull-requests: write  # Required for posting plan as PR comment

jobs:
  # ------------------------------------------------------------------
  # Job 1: Validate + Plan (runs on all PRs and pushes)
  #
  # Matrix strategy runs dev and eks-prod in parallel.
  # ------------------------------------------------------------------
  plan:
    name: "Plan — ${{ matrix.environment }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - environment: dev
            working_dir: environments/dev
            backend_config: backend-config-dev.hcl
          - environment: eks-prod
            working_dir: environments/eks-prod
            backend_config: backend-config-eks-prod.hcl

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Terraform Init
        working-directory: ${{ matrix.working_dir }}
        run: terraform init -backend-config=${{ matrix.backend_config }}

      - name: Terraform Format Check
        working-directory: ${{ matrix.working_dir }}
        run: terraform fmt -check -recursive ../../
        continue-on-error: true

      - name: Terraform Validate
        working-directory: ${{ matrix.working_dir }}
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ${{ matrix.working_dir }}
        run: terraform plan -var-file=terraform.tfvars -no-color -out=tfplan 2>&1 | tee plan-output.txt
        continue-on-error: true

      - name: Post Plan to PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('${{ matrix.working_dir }}/plan-output.txt', 'utf8');
            const truncatedPlan = plan.length > 60000
              ? plan.substring(0, 60000) + '\n\n... (truncated)'
              : plan;

            const body = `## Terraform Plan — \`${{ matrix.environment }}\`

            \`\`\`
            ${truncatedPlan}
            \`\`\`

            **Plan Status:** ${{ steps.plan.outcome }}

            > Merging to main will trigger \`terraform apply\` with manual approval required.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

  # ------------------------------------------------------------------
  # Job 2: Apply — dev (EC2 + API Gateway environment)
  #
  # IMPORTANT: Configure the "production-infra" environment in
  # GitHub Settings > Environments with required reviewers.
  # ------------------------------------------------------------------
  apply-dev:
    name: "Apply — dev"
    needs: plan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    environment: production-infra  # Requires manual approval in GitHub

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Terraform Init
        working-directory: environments/dev
        run: terraform init -backend-config=backend-config-dev.hcl

      - name: Terraform Apply
        working-directory: environments/dev
        run: terraform apply -var-file=terraform.tfvars -auto-approve

      - name: Output Endpoints
        working-directory: environments/dev
        run: |
          echo "=== dev Deployment Outputs ==="
          terraform output -json
          echo ""
          echo "API Gateway URL:"
          terraform output -raw api_gateway_url
          echo ""
          echo "EC2 Instance ID:"
          terraform output -raw ec2_instance_id

  # ------------------------------------------------------------------
  # Job 3: Apply — eks-prod (EKS HA cluster + K8s workloads)
  #
  # IMPORTANT: Configure the "eks-prod-infra" environment in
  # GitHub Settings > Environments with:
  #   - Required reviewers (add yourself or your team)
  #   - Deployment branch restriction to "main"
  #
  # This ensures terraform apply NEVER runs without human approval.
  # ------------------------------------------------------------------
  apply-eks-prod:
    name: "Apply — eks-prod"
    needs: plan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    environment: eks-prod-infra  # Requires manual approval in GitHub

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Terraform Init
        working-directory: environments/eks-prod
        run: terraform init -backend-config=backend-config-eks-prod.hcl

      - name: Terraform Apply
        working-directory: environments/eks-prod
        run: terraform apply -var-file=terraform.tfvars -auto-approve

      - name: Configure kubectl
        working-directory: environments/eks-prod
        run: |
          CLUSTER_NAME=$(terraform output -raw eks_cluster_name)
          REGION=$(terraform output -raw aws_region 2>/dev/null || echo "us-east-1")
          aws eks update-kubeconfig --name "$CLUSTER_NAME" --region "$REGION"

      - name: Verify EKS Deployment
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          echo ""
          echo "=== Nodes ==="
          kubectl get nodes -o wide
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n prod -o wide
          echo ""
          echo "=== Services ==="
          kubectl get svc -n prod
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n prod

      - name: Output Endpoints
        working-directory: environments/eks-prod
        run: |
          echo "=== eks-prod Deployment Outputs ==="
          terraform output -json
          echo ""
          echo "=========================================="
          echo "  EKS Cluster:  $(terraform output -raw eks_cluster_name)"
          echo "  ALB DNS:      $(terraform output -raw alb_dns_name)"
          echo "  NLB DNS:      $(terraform output -raw nlb_dns_name)"
          echo "  CloudFront:   $(terraform output -raw cloudfront_domain_name)"
          echo "  Frontend S3:  $(terraform output -raw frontend_bucket)"
          echo "=========================================="
